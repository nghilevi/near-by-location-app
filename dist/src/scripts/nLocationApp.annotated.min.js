/*! nLocationApp 29-07-2015 */
angular.module("nearByLocationApp",["ngAnimate","ngRoute","appControllers","appServices","appDirectives","appInterceptors"]).config(["$routeProvider","$httpProvider","$provide",function(a,b,c){b.interceptors.push("fSClientParamsInjector","timeStampMarker"),c.decorator("geolocation",["$delegate","$q",function(a,b){console.log("decorator is instantiated");var c=a.getLocation,d=b.defer();return a.getLocation=function(){return console.log("$delegate.getLocation is called"),c().then(function(a){d.resolve(a.coords.latitude+","+a.coords.longitude)}),d.promise},a.getUserLocation=function(){return console.log("$delegate.getUserLocation is called"),c().then(function(a){d.resolve(a.coords.latitude+","+a.coords.longitude)}),d.promise},a}]),a.when("/",{templateUrl:"src/views/listView.html",controller:"listViewCtrl"}).otherwise({templateUrl:"src/views/404.html"})}]),angular.module("appConstants",[]).constant("clientConst",{API_URL:"https://api.foursquare.com/v2/venues/search",CLIENT_ID:"GHRRJV4NQKK32TRCJ4Y4E01M3U3KFTCAE0ONRQMXH4LK1OFW",CLIENT_SECRET:"3ONADSWS2JOBXDD2XX2YCAZJQ3UUAI5YRMIETNT1WOOT04T0",CLIENT_VERSION:"20150408",ZERO_RESULT:{name:"No results found",distance:"",address:"Please type in another search terms"},ERROR:{name:"Something's wrong !!!",distance:"",address:"Please wait/refresh the page, make sure you've provided secret ID and select 'Share Location'"},UNIT:"m"}),angular.module("appControllers",["appServices"]).controller("listViewCtrl",["$scope","searchService","$timeout",function(a,b,c){a.venueList=[];var d;a.search=function(e){a.loading=!0,c.cancel(d),d=c(function(){b.search(e).then(function(b){a.venueList=b})["finally"](function(){a.loading=!1})},500)}}]),angular.module("appDirectives",["appFilters"]).directive("venueItem",function(){return{restrict:"E",scope:{venue:"="},link:function(a){},template:'<a ng-href="{{venue.location | googleMapLink}}" target="_blank">\n  <li class="info">\n    <h3 class="name">{{venue.name}}{{venue.distance | venueDistance}}</h3>\n    <p class="address">{{venue.address}}</p>\n  </li>\n</a>'}}),angular.module("appFilters",["appConstants"]).filter("venueDistance",["clientConst",function(a){return function(b){return b?" - "+b+a.UNIT+" away":""}}]).filter("googleMapLink",["clientConst",function(a){return function(a){return a?"http://maps.google.com/?q="+a:""}}]),angular.module("appInterceptors",["appConstants"]).factory("fSClientParamsInjector",["clientConst",function(a){return{request:function(b){return b.url==a.API_URL&&a.CLIENT_ID&&a.CLIENT_SECRET&&(b.params.client_id=a.CLIENT_ID,b.params.client_secret=a.CLIENT_SECRET,b.params.v=a.CLIENT_VERSION),b}}}]).factory("timeStampMarker",function(){return{request:function(a){return a.requestTimeStamp=(new Date).getTime(),a},response:function(a){return a.config.respondTimeStamp=(new Date).getTime(),a}}}),angular.module("appServices",["appConstants","geolocation"]).value("baseUrlBuilder",{baseUrl:"",id:function(a){return this.baseUrl+="?client_id="+a,this},secret:function(a){return this.baseUrl+="&client_secret="+a,this},version:function(a){return this.baseUrl+="&v="+a,this},geoData:function(a){return this.baseUrl+="&ll="+a.coords.latitude+","+a.coords.longitude+"&query=",this},get:function(){return this.baseUrl},init:function(){return this.baseUrl="https://api.foursquare.com/v2/venues/search",this}}).factory("fSBaseUrl",["geolocation","clientConst","baseUrlBuilder",function(a,b,c){function d(){return a.getLocation().then(function(a){b.CLIENT_SECRET&&(e=c.init().id(b.CLIENT_ID).secret(b.CLIENT_SECRET).version(b.CLIENT_VERSION).geoData(a).get())}),e}var e;return d(),{getBaseURL:function(){return e?e:d()}}}]).factory("searchService",["$http","$q","fSBaseUrl","clientConst",function(a,b,c,d){function e(a){return a.data}function f(a,b){a=angular.fromJson(a);var c,e=a.response.venues;return c=0!=e.length?e.map(function(a){return{location:a.location.lat+","+a.location.lng,name:a.name,distance:a.location.distance,address:(a.location.address||"")+" "+(a.location.city||"")}}):[d.ZERO_RESULT]}var g=function(g){var h=c.getBaseURL();return h?a.get(h+g,{transformResponse:f}).then(e):b.resolve([d.ERROR])};return{search:g}}]),angular.module("appServices",["appConstants","geolocation","appInterceptors"]).factory("searchService",["$http","$q","clientConst","geolocation",function(a,b,c,d){function e(a){var b=a.config.respondTimeStamp-a.config.requestTimeStamp;return console.log("The request took "+b/1e3+" seconds."),a.data}function f(a,b){a=angular.fromJson(a);var d,e=a.response.venues;return d=0!=e.length?e.map(function(a){return{location:a.location.lat+","+a.location.lng,name:a.name,distance:a.location.distance,address:(a.location.address||"")+" "+(a.location.city||"")}}):[c.ZERO_RESULT]}var g;d.getLocation().then(function(a){g=a});var h=function(d){if(g){var h={url:c.API_URL,method:"GET",params:{query:d,ll:g},transformResponse:f};return a(h).then(e)}return b.resolve([c.ERROR])};return{search:h}}]);